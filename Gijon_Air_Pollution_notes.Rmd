---
title: "Gijon_Air_Pollution"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Gijon Air Pollution notes

Notes about the development of my capstone final project of my Master on Data Science in KSchool.

### Project goals:

  - Construct a web dashboard to visualize the evolution of the main air pollution indicators of Gijon city. (Asturias; Spain).
  - Build a model to try to predict the probability of exceeding the pollution limits established by the EU in the city of Gijon (one day in advance).

#### History

2018-08-16 
I created my github repository.
I set the main goals of the project.

#### References

- OpenAir package web: http://davidcarslaw.github.io/openair/
- Breezometer: https://breezometer.com/real-time-air-quality

#### Data gathering

Loading packages
```{r }
library(readr)
library(dplyr)
library(openair) # http://davidcarslaw.github.io/openair/
library(purrr)
library(lubridate)

```


First of all I have to check if I will have the basic data to make the analysis. I need air pollution and weather data of the Gijon area. 
The town hall of Gijon has an open data web portal here https://transparencia.gijon.es/. We can download pollution air data on several formats from year 2000 to 2017 here: https://transparencia.gijon.es/search/risp_dataset/page/1808-catalogo-de-datos?utf8=%E2%9C%93&search=aire+&search_sector=&search_format=&commit=Buscar&authenticity_token=j8%2F3CvCuPcDkrRe%2F1NR5RBp0t%2FOOosiA7724w3T2mB4%3D

I downloaded 18 csv files with air pollution and weather data of Gijón from years 2000 to 2017. I saved them in the "data" folder.
I downloaded two more files from this web, a csv file with the description of the variables and another csv file with information about the measuremente stations. 

```{r }
variables <- read_csv('data/air_data_descriptors.csv', locale = locale(encoding = "ISO-8859-1"))
variables

```


```{r }
data_files <- list.files(path = "data", pattern = "air_data_20*")
air_data_0 <- data_files %>% 
    map(function(x) {
        read_csv(paste0("./data/", x), locale = locale(encoding = "ISO-8859-1"))
    }) %>%
    reduce(rbind)

air_data_1 <- air_data_0 %>% rename(station = `Estación`,
                                    station_name = `Título`,
                                    date_time_utc = `Fecha Solar (UTC)`)

air_data_1$station <- as.factor(air_data_1$station)
air_data_1$station_name <- as.factor(air_data_1$station_name)
air_data_1$BEN <- as.numeric(air_data_1$BEN)
air_data_1$TOL <- as.numeric(air_data_1$TOL)
air_data_1$MXIL <- as.numeric(air_data_1$MXIL)
air_data_1$PM25 <- as.numeric(air_data_1$PM25)

summary(air_data_1)

glimpse(air_data_1)

  hist(air_data_1$SO2)
air <- air_data_1 %>% filter(SO2 != '-9999')

air_data_2 <- air_data_1 %>% mutate(SO2 = replace(SO2, SO2 < 0, NA),
                                    NO = replace(NO, NO < 0, NA),
                                    NO2 = replace(NO2, NO2 < 0, NA),
                                    PM10 = replace(PM10, PM10 < 0, NA),
                                    O3 = replace(03, 03 < 0, NA))

summary(air_data_2)

nas <- air_data_2 %>% 
  group_by(station_name, year(date_time_utc)) %>%
  select(everything()) %>%  
  summarise_all(funs(sum(is.na(.))))

nas_per <- air_data_2 %>% 
  group_by(station_name, station year(date_time_utc)) %>%
  select(everything()) %>%  
  summarise_all(funs(round(sum(is.na(.))/n(), 2)))

data_completion <- air_data_2 %>% 
  group_by(station_name, station, year(date_time_utc)) %>%
  select(everything()) %>%  
  summarise_all(funs(round(sum(!is.na(.))/n(), 2)))



constitucion_data <- data_completion %>% filter(station == '1')
# constitución: desde el anho 2000 tiene registrados datos de SO2, NO, NO2, CO, PM10, 03, dd, vv, TMP, 
# HR, PRB, HS y LL, 
# A partir del anho 2007 tambien existen datos de BEN, TOL y MXIL. Y a partir de 2009 se empieza a medir # las particulas PM25.
# en el anho 2008 desciende la completacion de los datos hasta el 88% de las variables dd, vv, TMP, 
# HR, PRB, HS, LL, BEN, TOL y MXIL (comprobar que no haya sido un problema de importacion de los datos)

argentina_data <- data_completion %>% filter(station == '2')
# argentina: datos desde el anho 2000. Solo de las variables SO2, NO, NO2, CO, PM10 y 03. 

felgueroso_data <- data_completion %>% filter(station == '3')
# felgueroso: datos desde el anho 2000. Solo de las variables SO2, NO, NO2, CO, PM10 y 03. 

castilla_data <- data_completion %>% filter(station == '4')
# castilla: datos desde el anho 2000. Solo de las variables SO2, NO, NO2, CO, PM10 y 03.

montevil_data <- data_completion %>% filter(station == '10')
# montevil: datos desde 2009. Solo datos de las variables SO2, NO, NO2, 03, dd, vv, TMP, HR, PRB, HS, 
# LL y PM25
# sin datos de las variables CO, PM10, BEN, TOL y MXIL

barbara_data <- data_completion %>% filter(station == '11')
# barbara: solo datos de 2016 y 2017 de las variables NO, NO2, CO, PM10, 03 y PM25

# air_data_2 <- map_df(data_files, read_csv,  "./data/", locale = locale(encoding = "ISO-8859-1"))




```



