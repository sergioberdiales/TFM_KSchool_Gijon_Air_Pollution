---
title: "Gijon Air Pollution - Prediction Models"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Loading packages
```{r , warning= FALSE, message= FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(openair) # http://davidcarslaw.github.io/openair/
library(purrr)
library(lubridate)
library(ggplot2)
library(stringr)
library(knitr)
library(xts)
library(zoo)
library(gridExtra)
library(astsa)
library(rvest)
library(fpp2)
library(ranger)
library(broom)
library(RcppRoll)
library(caret)
```

"Prediction is very difficult, especially if it's about the future."
--Nils Bohr, Nobel laureate in Physics

"I have seen the future and it is very much like the present, only longer."
--Kehlog Albran, The Profit


Data loading
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
air_data_2 <- readRDS("air_data_2.rds")
constitucion_data <- readRDS("constitucion_data.rds")

```

# PM10 hourly prediction models


Training period: October 2017
Testing period: 1 November 2017


```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

train_ts <- pm10_2017_10 <- constitucion_data %>% filter(year == 2017, 
                                                          month == 10) %>% 
                                                          select(PM10) %>% 
                                                          rename(pm10_0 = PM10)  %>%
                                                          na.omit() %>%
                                                          ts(frequency = 24)


autoplot(train_ts)

test <- pm10_2017_11_01 <- constitucion_data %>% filter(date_time_utc >= '2017-11-01 00:00:00',
                                                           date_time_utc <= '2017-11-01 23:00:00') %>% 
                                                            select(PM10) %>% 
                                                            rename(pm10_0 = PM10)

test_ts <- pm10_2017_11_01 <- constitucion_data %>% filter(date_time_utc >= '2017-11-01 00:00:00',
                                                           date_time_utc <= '2017-11-01 23:00:00') %>% 
                                                            select(PM10) %>% 
                                                            rename(pm10_0 = PM10)  %>%
                                                            na.omit() %>% 
                                                              ts(frequency = 24)
autoplot(test_ts)

```


ARIMA

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
model_arima=auto.arima(train_ts,seasonal=TRUE,trace=TRUE)
plot(forecast(model_arima,h=24))
summary(model_arima)

test$arima=forecast(model_arima,h=24)$mean

```

Lineal Regression
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
model_tslm=tslm(train_ts~trend + season,data=train_ts)
summary(model_tslm)
plot(forecast(model_tslm, fan=TRUE,h=24))
forecast(model_tslm,level=c(80,95),h=24)

test$tslm=forecast(model_tslm,h=24)$mean
```

Moving average
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
model_ma=ma(train_ts,order=3)
summary(model_ma)
plot(forecast(model_ma, fan=TRUE,h=24))
forecast(model_ma, level=c(80,95),h=24)

test$MA=forecast(model_ma,h=24)$mean

```

Holt Winters
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
model_hw=HoltWinters(train_ts)
summary(model_hw)
plot(forecast(model_hw, fan=TRUE,h=24))
forecast(model_hw,level=c(80,95),h=24)

test$HW=forecast(model_hw,h=24)$mean

```


```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
test$hour <- c(0:23)
test_long <- gather(test, model, value, -hour)
ggplot(test_long, aes(y = value, x = hour, colour = model)) + 
        geom_line() +
        scale_y_continuous(limits = c(0, NA)) + 
        labs(xlab("Hour")) +
        labs(ylab("PM10 level"))

```

Pendiente. 
     - Calcular RMSE para todos los modelos y comparar.
     - Hacer predicciones con nuevos datos. 
     - Que hacemos con las predicciones negativas (extremos bajos de los intervalos de confianza)



Una vez realizados estos ejemplos de predicción de series temporales con modelos estadísticos más tradicionales, vamos a pasar a aplicar otro tipo de algoritmos pertenecientes al mundo del Machine Learning. 

Inicialmente vamos a utilizar como variables explicativas de los modelos únicamente variables retardadas de la misma  variable a explicar (en este caso el Nivel de concentración de PM10 en la estación de medición de Avenida de la Constitución en horas precedentes). Más tarde iremos introduciendo otras variables explicativas, como información meteorológica también medida por esta estación. Pero siempre de horas pasadas, ya que el objetivo es construir un modelo de predicción ex-ante. 

El objetivo final es construir un modelo que nos dé una predicción de los niveles de PM10 en las 24 horas siguientes, pero vamos a comenzar con la predicción de una única hora, que sería la hora siguiente a la última hora con dato disponible. 


Training period: Years 2014, 2015 and 2016.
Testing period: January 2017.



```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

constitucion_data <- readRDS("constitucion_data.rds")

train_2014_2016 <- constitucion_data %>% filter(year > 2013, 
                                        year < 2017) %>% 
                                        select(PM10) %>% 
                                        rename(pm10_0 = PM10) %>%
                                        na.omit()

train_2009_2016 <- constitucion_data %>% filter(year > 2008, 
                                        year < 2017) %>% 
                                        select(PM10) %>% 
                                        rename(pm10_0 = PM10) %>%
                                        na.omit()

train_0_lite <- constitucion_data %>% filter(date_time_utc >= '2016-10-01 00:00:00',
                                       date_time_utc < '2017-01-01 00:00:00') %>% 
                                        select(PM10) %>% 
                                        rename(pm10_0 = PM10) %>%
                                        na.omit()

test_lite <- constitucion_data %>% filter(date_time_utc >= '2017-01-01 00:00:00',
                                       date_time_utc < '2017-02-01 00:00:00') %>%
                                       select(PM10) %>%
                                       rename(pm10_0 = PM10) %>%
                                       na.omit()

test_201701_201709 <- constitucion_data %>% filter(date_time_utc >= '2017-01-01 00:00:00',
                                       date_time_utc < '2017-10-01 00:00:00') %>%
                                       select(PM10) %>%
                                       rename(pm10_0 = PM10) %>%
                                       na.omit()

validation_set <- constitucion_data %>% filter(date_time_utc >= '2017-10-01 00:00:00',
                                       date_time_utc <= '2017-12-31 00:00:00') %>%
                                       select(PM10) %>%
                                       rename(pm10_0 = PM10) %>%
                                       na.omit()


# We create the PM10 lagged variables

train_2014_2016 <- train_2014_2016 %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_48 = lag(pm10_0, 48),
                  pm10_72 = lag(pm10_0, 72),
                  pm10_96 = lag(pm10_0, 96),
                  pm10_120 = lag(pm10_0, 120),
                  pm10_144 = lag(pm10_0, 144),
                  pm10_168 = lag(pm10_0, 168)) %>%
  na.omit()

train_2009_2016 <- train_2009_2016 %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_48 = lag(pm10_0, 48),
                  pm10_72 = lag(pm10_0, 72),
                  pm10_96 = lag(pm10_0, 96),
                  pm10_120 = lag(pm10_0, 120),
                  pm10_144 = lag(pm10_0, 144),
                  pm10_168 = lag(pm10_0, 168)) %>%
  na.omit()

train_1_lite <- train_0_lite %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_48 = lag(pm10_0, 48),
                  pm10_72 = lag(pm10_0, 72),
                  pm10_96 = lag(pm10_0, 96),
                  pm10_120 = lag(pm10_0, 120),
                  pm10_144 = lag(pm10_0, 144),
                  pm10_168 = lag(pm10_0, 168)) %>%
  na.omit()

test_lite <- test_lite %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_48 = lag(pm10_0, 48),
                  pm10_72 = lag(pm10_0, 72),
                  pm10_96 = lag(pm10_0, 96),
                  pm10_120 = lag(pm10_0, 120),
                  pm10_144 = lag(pm10_0, 144),
                  pm10_168 = lag(pm10_0, 168)) %>%
  na.omit()


test_201701_201709 <- test_201701_201709 %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_48 = lag(pm10_0, 48),
                  pm10_72 = lag(pm10_0, 72),
                  pm10_96 = lag(pm10_0, 96),
                  pm10_120 = lag(pm10_0, 120),
                  pm10_144 = lag(pm10_0, 144),
                  pm10_168 = lag(pm10_0, 168)) %>%
  na.omit()

```

Exportamos train_1 y test_1 como csvs para subirlos a Google Colab y montar los modelos con Python. 

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

y_train_2014_2016 <- train_2014_2016 %>% select(pm10_0)
X_train_2014_2016 <- train_2014_2016 %>% select(-pm10_0)

write_csv(X_train_2014_2016, "train_test_csvs/X_train_2014_2016.csv")
write_csv(y_train_2014_2016, "train_test_csvs/y_train_2014_2016.csv")

y_train_2009_2016 <- train_2009_2016 %>% select(pm10_0)
X_train_2009_2016 <- train_2009_2016 %>% select(-pm10_0)

write_csv(X_train_2009_2016, "train_test_csvs/X_train_2009_2016.csv")
write_csv(y_train_2009_2016, "train_test_csvs/y_train_2009_2016.csv")

y_train_lite <- train_1_lite %>% select(pm10_0)
X_train_lite <- train_1_lite %>% select(-pm10_0)

write_csv(X_train_lite, "train_test_csvs/X_train_lite.csv")
write_csv(y_train_lite, "train_test_csvs/y_train_lite.csv")

y_test_lite <- test_lite %>% select(pm10_0)
X_test_lite <- test_lite %>% select(-pm10_0)

write_csv(X_test_lite, "train_test_csvs/X_test_lite.csv")
write_csv(y_test_lite, "train_test_csvs/y_test_lite.csv")

y_test_201701_201709 <- test_201701_201709 %>% select(pm10_0)
X_test_201701_201709 <- test_201701_201709 %>% select(-pm10_0)

write_csv(X_test_201701_201709, "train_test_csvs/X_test_201701_201709.csv")
write_csv(y_test_201701_201709, "train_test_csvs/y_test_201701_201709.csv")



```






```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

outcome <- "pm10_0"

#vars <- colnames(train)[2:25]
(fmla <- paste(outcome, "~", "pm10_1"))


```

















































Prepare the variables

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

train_0 <- pm10_2014_2016 <- constitucion_data %>% filter(year > 2013, 
                                                          year < 2017) %>% 
                                                          select(PM10) %>% 
                                                          rename(pm10_0 = PM10)

train_ts <- pm10_2014_2016 <- constitucion_data %>% filter(year > 2013, 
                                                          year < 2017) %>% 
                                                          select(PM10) %>% 
                                                          rename(pm10_0 = PM10) %>%
                                                          na.omit() %>%
                                                          ts(start = c(2013, 1, 1), frequency = 24)


test <- pm10_2017 <- constitucion_data %>% filter(year == 2017) %>% 
                                          select(PM10) %>% 
                                          rename(pm10_0 = PM10)

# We create a new variable, the lagged version of pm10_0

train_1 <- train_0 %>% mutate(pm10_1 = lag(pm10_0, 1)) %>% 
  na.omit

train <- ts(train_1, start=c(2013,1,1),frequency=24)
```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

outcome <- "pm10_0"

#vars <- colnames(train)[2:25]
(fmla <- paste(outcome, "~", "pm10_1"))


```

Linear regression
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth', cache = TRUE}
(pm10_model_lm_0 <- lm(fmla, train))
```


```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

(lm_0_model_summary <- summary(pm10_model_lm_0))

```

We are getting a R-squared of 57.86% with a linear regression model with just one explanatory variable. We are going to use this model as our base model. 

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
plot(forecast(pm10_model_lm_0, fan=TRUE, h=24))

```

We add another variable to the model, another lagged version of the variable to predict pm10_0

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}


train <- train %>% mutate(pm10_1 = lag(pm10_0, 1),
                          pm10_2 = lag(pm10_0, 2)) %>% 
                    na.omit

outcome <- "pm10_0"

vars <- colnames(train)[2:3]
(fmla <- paste(outcome, "~", paste(vars, collapse = " + ")))


```


Linear regression
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth', cache = TRUE}
(pm10_model_lm_1 <- lm(fmla, train))
```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

(lm_1_model_summary <- summary(pm10_model_lm_1))

```

The R-squared increases until 59.33 %. 




Adding more lagged variables.

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}


train <- train %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24)
) %>% na.omit

outcome <- "pm10_0"

vars <- colnames(train)[2:25]
(fmla <- paste(outcome, "~", paste(vars, collapse = " + ")))


```

Linear regression
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth', cache = TRUE}
(pm10_model_lm_2 <- lm(fmla, train))
```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

(lm_2_model_summary <- summary(pm10_model_lm_2))

```

R-Squared: 60.68%
Only 10 out of the 24 variables have a p-value under 0.05. 




ARIMA model
Revisar. Creo que el parametro frequency esta mal fijado. Tendria que ser el numero de observaciones en un año. 
Modelo resultante guardado en model_arima_hour
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

air_data_2 <- readRDS("air_data_2.rds")

constitucion_data <- air_data_2 %>% filter(station == "1")

saveRDS(constitucion_data, file = "constitucion_data.rds")

train_pm10 <- constitucion_data %>% filter(date_time_utc < '2017-01-01 00:00:00') %>%
                                    select(PM10)
train_pm10_ts <- ts(train_pm10$PM10, start = 2000, frequency = 24) 

train_pm10_2014_2016 <- constitucion_data %>% filter(date_time_utc < '2017-01-01 00:00:00',
                                                     date_time_utc >= '2014-01-01 00:00:00') %>%
                                                select(PM10)

train_pm10_ts_2014_2016 <- ts(train_pm10_2014_2016$PM10, start = 2014, frequency = 24) 


test_pm10 <- constitucion_data %>% filter(date_time_utc >= '2017-01-01 00:00:00') %>%
                                    select(PM10)

test_pm10_ts <- ts(test_pm10$PM10, start = 2017, frequency = 24)

test_pm10_15_days <- constitucion_data %>% filter(date_time_utc >= '2017-01-01 00:00:00',
                                          date_time_utc < '2017-01-16 00:00:00') %>%
                                    select(PM10) %>% na.omit

test_pm10_15_days_ts <- ts(test_pm10$PM10, start = 2017, frequency = 24)



```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

model_arima=auto.arima(train_pm10_ts_2014_2016,seasonal=TRUE,trace=TRUE)
plot(forecast(model_arima,h=360))
summary(model_arima)

model_arima_hour <- readRDS("model_arima_hour.rds")

#test_pm10_15_days$arima_hour=forecast(model_arima_hour,h=24)$mean

test_pm10_15_days$arima_hour=fitted(model_arima_hour, h=24)

model_arima_hour_0 <- model_arima
# saveRDS(model_arima_hour_0, file = "model_arima_hour.rds")

autoplot(test_pm10_15_days_ts, series="Test data") 
+
  autolayer(fitted(model_arima_hour, h=24),
    series="24-step fitted values")

```

First model. Just one lagged value of the pm10 variable. 

Prepare the variables
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

air_data_2 <- readRDS("air_data_2.rds")

constitucion_data <- air_data_2 %>% filter(station == "1")
pm10_var_2000_2016 <- constitucion_data %>% filter(year < 2017) %>% select(PM10) %>% rename(pm10_0 = PM10)

pm10_var_2017 <- constitucion_data %>% filter(year == 2017) %>% select(PM10) %>% rename(pm10_0 = PM10)

train <- pm10_var_2000_2016 
test <- pm10_var_2017

# Convert this code in a loop
train <- train %>% mutate(pm10_1 = lag(pm10_0, 1)) %>% 
                    na.omit


```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

outcome <- "pm10_0"

#vars <- colnames(train)[2:25]
(fmla <- paste(outcome, "~", "pm10_1"))


```

Linear regression
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
(pm10_model_lm_0 <- lm(fmla, train))
```


```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

summary(pm10_model_lm_0)

```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
(pm10_model_rf_0 <- ranger(fmla, 
                         train, 
                         num.trees = 1000, 
                         respect.unordered.factors = "order", 
                         seed = 42))
```


```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
MSE <- pm10_model_rf_0$prediction.error
(RMSE <- sqrt(MSE))
(sd(train$pm10_0))
```

The RMSE (14.5) is smaller than the sd (23.2). It means that the model is at least a better predictor model than the mean. 

First model. Just 24 lagged values of the pm10 variable. 

Prepare the variables
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

air_data_2 <- readRDS("air_data_2.rds")

constitucion_data <- air_data_2 %>% filter(station == "1")
pm10_var_2014_2016 <- constitucion_data %>% filter(year < 2017) %>% select(PM10) %>% rename(pm10_0 = PM10)

pm10_var_2017 <- constitucion_data %>% filter(year == 2017) %>% select(PM10) %>% rename(pm10_0 = PM10)

train <- pm10_var_2014_2016 
test <- pm10_var_2017

# Convert this code in a loop
train <- train %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24)
) %>% na.omit


```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

outcome <- "pm10_0"
vars <- colnames(train)[2:25]
(fmla <- paste(outcome, "~", paste(vars, collapse = " + ")))


```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
(pm10_model_rf_1 <- ranger(fmla, 
                         train, 
                         num.trees = 1000, 
                         respect.unordered.factors = "order", 
                         seed = 42))
```




Prepare the variables
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

air_data_2 <- readRDS("air_data_2.rds")

constitucion_data <- air_data_2 %>% filter(station == "1")
pm10_var_2000_2016 <- constitucion_data %>% filter(year < 2017) %>% select(PM10, month, week_day, hour) %>% rename(pm10_0 = PM10)

pm10_var_2017 <- constitucion_data %>% filter(year == 2017) %>% select(PM10, month, week_day, hour) %>% rename(pm10_0 = PM10)

train <- pm10_var_2014_2016 
test <- pm10_var_2017

train$month <- as.factor(train$month)
train$week_day <- as.factor(train$week_day)
train$hour <- as.factor(train$hour)

# Convert this code in a loop
train <- train %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_168 = lag(pm10_0, 168)
) %>% na.omit


```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

outcome <- "pm10_0"
vars <- colnames(train)[2:29]
(fmla <- paste(outcome, "~", paste(vars, collapse = " + ")))


```
```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
(pm10_model_rf <- ranger(fmla, 
                         train, 
                         num.trees = 1000, 
                         respect.unordered.factors = "order", 
                         seed = 42))
```

R squared = 67%

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

summary(pm10_model_rf)

```

Trato de mejorar el modelo introduciendo variables de tiempo atmosferico.

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

pm10_var_2000_2016 <- constitucion_data %>% filter(year < 2017) %>%
                                            select(PM10, month, week_day, hour, PRB) %>% 
                                            rename(pm10_0 = PM10,
                                                   prb_0 = PRB)

pm10_var_2017 <- constitucion_data %>% filter(year == 2017) %>% 
                                        select(PM10, month, week_day, hour, PRB) %>%
                                        rename(pm10_0 = PM10, 
                                               prb_0 = PRB)
                                                                                                                    

train <- pm10_var_2000_2016 
test <- pm10_var_2017

# Convert this code in a loop
train <- train %>% mutate(pm10_1 = lag(pm10_0, 1),
                  pm10_2 = lag(pm10_0, 2),
                  pm10_3 = lag(pm10_0, 3),
                  pm10_4 = lag(pm10_0, 4),
                  pm10_5 = lag(pm10_0, 5),
                  pm10_6 = lag(pm10_0, 6),
                  pm10_7 = lag(pm10_0, 7),
                  pm10_8 = lag(pm10_0, 8),
                  pm10_9 = lag(pm10_0, 9),
                  pm10_10 = lag(pm10_0, 10),
                  pm10_11 = lag(pm10_0, 11),
                  pm10_12 = lag(pm10_0, 12),
                  pm10_13 = lag(pm10_0, 13),
                  pm10_14 = lag(pm10_0, 14),
                  pm10_15 = lag(pm10_0, 15),
                  pm10_16 = lag(pm10_0, 16),
                  pm10_17 = lag(pm10_0, 17),
                  pm10_18 = lag(pm10_0, 18),
                  pm10_19 = lag(pm10_0, 19),
                  pm10_20 = lag(pm10_0, 20),
                  pm10_21 = lag(pm10_0, 21),
                  pm10_22 = lag(pm10_0, 22),
                  pm10_23 = lag(pm10_0, 23),
                  pm10_24 = lag(pm10_0, 24),
                  pm10_168 = lag(pm10_0, 168)) %>% 
                    mutate(prb_1 = lag(prb_0, 1),
                  prb_2 = lag(prb_0, 2),
                  prb_3 = lag(prb_0, 3),
                  prb_4 = lag(prb_0, 4),
                  prb_5 = lag(prb_0, 5),
                  prb_6 = lag(prb_0, 6),
                  prb_7 = lag(prb_0, 7),
                  prb_8 = lag(prb_0, 8),
                  prb_9 = lag(prb_0, 9),
                  prb_10 = lag(prb_0, 10),
                  prb_11 = lag(prb_0, 11),
                  prb_12 = lag(prb_0, 12),
                  prb_13 = lag(prb_0, 13),
                  prb_14 = lag(prb_0, 14),
                  prb_15 = lag(prb_0, 15),
                  prb_16 = lag(prb_0, 16),
                  prb_17 = lag(prb_0, 17),
                  prb_18 = lag(prb_0, 18),
                  prb_19 = lag(prb_0, 19),
                  prb_20 = lag(prb_0, 20),
                  prb_21 = lag(prb_0, 21),
                  prb_22 = lag(prb_0, 22),
                  prb_23 = lag(prb_0, 23),
                  prb_24 = lag(prb_0, 24),
                  prb_168 = lag(prb_0, 168))  %>% na.omit


```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}

outcome <- "pm10_0"
vars <- colnames(train)[2:55]
(fmla <- paste(outcome, "~", paste(vars, collapse = " + ")))


```

```{r warning = FALSE, message= FALSE, out.width= '\\textwidth'}
(pm10_model_rf <- ranger(fmla, 
                         train, 
                         num.trees = 1000, 
                         respect.unordered.factors = "order", 
                         seed = 42))
```

El MSE y el R cuadrado son casi exactamente los mismos. Esta variable no parece aportar nada. Por lo menos asi introducida.



