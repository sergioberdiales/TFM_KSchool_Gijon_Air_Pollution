
# Tables for Tableau

Loading packages
```{r , warning= FALSE, message= FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(purrr)
library(lubridate)
library(ggplot2)
library(stringr)
library(knitr)
library(xts)
library(zoo)
library(gridExtra)
library(fpp2)
library(RcppRoll)
library(kableExtra)

options(knitr.table.format = "html")
```

We load the data.
```{r warning = FALSE, message = FALSE}

air_data_2 <- readRDS("data_rds/air_data_2.rds")

```


### Tables preparation for Tableau Dashboards

We are going to prepare some tables for the Tableau dashboards.

First of all we export the whole table to a csv file. I am not saving this file in the "data_final_csvs" folder because it exceeds the Github file limit size (100mb)(pendiente exportar a google drive)

I save the air_data_2.csv outside the project diretory because it exceeds the 100mb github limit.
```{r warning = FALSE, message = FALSE}

# write_csv(air_data_2,"C:/Users/SErgio/OneDrive/00_master_data_science/TFM/air_data_2.csv")

```
#### CO tables

We create a CO dataset with CO Moving averages (each 8 hours). It is needed to measure the accomplishment of UE limits for this pollutant
```{r warning = FALSE, message = FALSE}

co_data <- air_data_2 %>% select(station_alias, date_time_utc, CO) %>%
                          mutate(ma_co_8 = roll_mean(CO, 8, fill=0))

hist(co_data$ma_co_8)
summary(co_data$ma_co_8)
plot(co_data$ma_co_8)

# pending na treatment

saveRDS(co_data, file = "data_rds/co_data.rds")
write_csv(co_data, "data_final_csvs/co_data.csv")


```

#### O3 tables

We create a O3 dataset with O3 Moving averages (each 8 hours). It is needed to measure the accomplishment of UE limits for this pollutant
```{r warning = FALSE, message = FALSE}

o3_data <- air_data_2 %>% select(station_alias, date_time_utc, O3) %>%
                          mutate(ma_o3_8 = roll_mean(O3, 8, fill=0),
                                 o3_8_acc = ifelse(ma_o3_8 > 125, 'no', 'yes'))


hist(o3_data$ma_o3_8)
summary(o3_data$ma_o3_8)
plot(o3_data$ma_o3_8)

# pending na treatment

saveRDS(o3_data, file = "data_rds/o3_data.rds")
write_csv(o3_data, "data_final_csvs/o3_data.csv")


```



#### SO2 tables

RD 102/2011
Hourly limit: 350 ug/m3 (1 hour). <= 24 times / year.
Daily limit: 125 ug/m3 (24 hours). <= 3 times / year.
Alert threshold: 500 ug/m3 (3 hours).


```{r warning = FALSE, message = FALSE}

so2_data <- air_data_2 %>% select(station_alias, date_time_utc, SO2)

saveRDS(so2_data, file = "data_rds/so2_data.rds")
write_csv(so2_data, "data_final_csvs/so2_data.csv")

# How many times was the Hourly limit exceeded during the last 18 years?

so2_hourly_limit <- so2_data %>%
                    group_by(station_alias,
                             year = year(date_time_utc),
                             day = date(date_time_utc)) %>%
                    filter(SO2 > 350) %>%
                    summarise(n = n()) %>%
                    arrange(year)


so2_hourly_limit

saveRDS(so2_hourly_limit, file = "data_rds/so2_hourly_limit.rds")
write_csv(so2_hourly_limit, "data_final_csvs/so2_hourly_limit.csv")


# How many times was the Daily limit exceeded during the last 18 years?

so2_daily_limit <- so2_data %>%
                    group_by(station_alias, date = date(date_time_utc), year = year(date_time_utc)) %>%
                    summarise(avg = mean(SO2, na.rm = TRUE)) %>%
                    ungroup %>%
                    filter(avg > 125) %>%
                    group_by(station_alias, year, date) %>%
                    summarise(n = n()) %>%
                    arrange(year)



so2_daily_limit

saveRDS(so2_daily_limit, file = "data_rds/so2_daily_limit.rds")
write_csv(so2_daily_limit, "data_final_csvs/so2_daily_limit.csv")

```

















We save the final dataset as a rds object.
```{r warning = FALSE, message = FALSE}

saveRDS(air_data_2, file = "data_rds/air_data_2.rds")

```

### Tables preparation for Tableau Dashboards

We are going to prepare some tables for the Tableau dashboards.

First of all we export the whole table to a csv file. I am not saving this file in the "data_final_csvs" folder because it exceeds the Github file limit size (100mb)(pendiente exportar a google drive)

I save the air_data_2.csv outside the project diretory because it exceeds the 100mb github limit.
```{r warning = FALSE, message = FALSE}

# write_csv(air_data_2,"C:/Users/SErgio/OneDrive/00_master_data_science/TFM/air_data_2.csv")

```
#### CO tables

We create a CO dataset with CO Moving averages (each 8 hours). It is needed to measure the accomplishment of UE limits for this pollutant
```{r warning = FALSE, message = FALSE}

co_data <- air_data_2 %>% select(station_alias, date_time_utc, CO) %>%
                          mutate(ma_co_8 = roll_mean(CO, 8, fill=0))

hist(co_data$ma_co_8)
summary(co_data$ma_co_8)
plot(co_data$ma_co_8)

# pending na treatment

saveRDS(co_data, file = "data_rds/co_data.rds")
write_csv(co_data, "data_final_csvs/co_data.csv")

```
